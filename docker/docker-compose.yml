version: '3.8'

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    container_name: federated_server
    ports:
      - "8000:8000"
    environment:
      - PYTHONUNBUFFERED=1
      - MODEL_NAME=${MODEL_NAME:-cnn}  # Model selection: cnn, cifar10_cnn, or resnet
      - USE_DISTRIBUTED=${USE_DISTRIBUTED:-false}  # Enable distributed aggregation (requires multiple GPUs)
    volumes:
      - ./experiments:/app/experiments
      - ./data:/app/data
    networks:
      - federated_net

  client_0:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: federated_client_0
    depends_on:
      - server
    environment:
      - SERVER_URL=http://server:8000
      - CLIENT_ID=0
      - NUM_CLIENTS=5
      - DEVICE=cpu
      - LOCAL_EPOCHS=2
      - BATCH_SIZE=64
      - LEARNING_RATE=0.01
      - NUM_ROUNDS=25
      - DIRICHLET_ALPHA=0.5
      - SEED=42
      - START_DELAY=15
      - PYTHONUNBUFFERED=1
      - MODEL_NAME=${MODEL_NAME:-cnn}  # Must match server model
    volumes:
      - ./data:/app/data
    networks:
      - federated_net
    restart: on-failure

  client_1:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: federated_client_1
    depends_on:
      - server
    environment:
      - SERVER_URL=http://server:8000
      - CLIENT_ID=1
      - NUM_CLIENTS=5
      - DEVICE=cpu
      - LOCAL_EPOCHS=2
      - BATCH_SIZE=64
      - LEARNING_RATE=0.01
      - NUM_ROUNDS=25
      - DIRICHLET_ALPHA=0.5
      - SEED=42
      - START_DELAY=15
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/app/data
    networks:
      - federated_net
    restart: on-failure

  client_2:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: federated_client_2
    depends_on:
      - server
    environment:
      - SERVER_URL=http://server:8000
      - CLIENT_ID=2
      - NUM_CLIENTS=5
      - DEVICE=cpu
      - LOCAL_EPOCHS=2
      - BATCH_SIZE=64
      - LEARNING_RATE=0.01
      - NUM_ROUNDS=25
      - DIRICHLET_ALPHA=0.5
      - SEED=42
      - START_DELAY=15
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/app/data
    networks:
      - federated_net
    restart: on-failure

  client_3:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: federated_client_3
    depends_on:
      - server
    environment:
      - SERVER_URL=http://server:8000
      - CLIENT_ID=3
      - NUM_CLIENTS=5
      - DEVICE=cpu
      - LOCAL_EPOCHS=2
      - BATCH_SIZE=64
      - LEARNING_RATE=0.01
      - NUM_ROUNDS=25
      - DIRICHLET_ALPHA=0.5
      - SEED=42
      - START_DELAY=15
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/app/data
    networks:
      - federated_net
    restart: on-failure

  client_4:
    build:
      context: .
      dockerfile: Dockerfile.client
    container_name: federated_client_4
    depends_on:
      - server
    environment:
      - SERVER_URL=http://server:8000
      - CLIENT_ID=4
      - NUM_CLIENTS=5
      - DEVICE=cpu
      - LOCAL_EPOCHS=2
      - BATCH_SIZE=64
      - LEARNING_RATE=0.01
      - NUM_ROUNDS=25
      - DIRICHLET_ALPHA=0.5
      - SEED=42
      - START_DELAY=15
      - PYTHONUNBUFFERED=1
    volumes:
      - ./data:/app/data
    networks:
      - federated_net
    restart: on-failure

  orchestrate:
    build:
      context: .
      dockerfile: Dockerfile.orchestrate
    container_name: federated_orchestrate
    environment:
      - PYTHONUNBUFFERED=1
      - DEVICE=cpu
      - MODEL_NAME=${MODEL_NAME:-cnn}  # Model selection: cnn, cifar10_cnn, or resnet
    volumes:
      - ./experiments:/app/experiments
      - ./data:/app/data
    networks:
      - federated_net
    profiles:
      - orchestrate  # Only run when explicitly requested

networks:
  federated_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16